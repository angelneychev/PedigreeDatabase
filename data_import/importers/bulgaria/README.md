# Bulgarian Dalmatian Registry Import

Импорт на данни от българския регистър на далматинци.

## Структура на файловете

```
bulgaria/
├── bulgaria_import_phase1_fixed.py      # Етап 1: Импорт на кучета
├── bulgaria_import_phase2_parents_fixed.py  # Етап 2: Импорт на липсващи родители  
├── bulgaria_import_phase3_relationships_fixed.py  # Етап 3: Свързване на родителски връзки
├── validate_bulgarian_import.py         # Валидация на импорта
├── delete_today_simple.py              # Инструмент за изчистване на базата данни
├── README.md                           # Документация
├── data/
│   └── Registar_BDK_2025_raboten.csv  # CSV файл с данни (194 записа)
└── logs/                               # Лог файлове от импорта
    ├── bulgaria_import_fixed_*.log
    ├── bulgaria_import_phase2_parents_*.log
    └── bulgaria_import_phase3_relationships_*.log
```

## CSV структура

Очакваният формат на CSV файла:

```csv
dateOfBirth;sex;name;microchip;regCode;fatherName;fatherRegNumber;motherName;motherRegNumber;breeder
17.05.2005 г.;Female;Divalinor Coffee Cake;;PK 04704/05;Bad & Mad Serbian Sensation in Raul;PK 02482/04;Sweet Emotion Panthera Unica;PK 03365/04;Димитър Станчев
```

### Полета:
- **dateOfBirth**: Дата на раждане (DD.MM.YYYY г.)
- **sex**: Пол (Male/Female)
- **name**: Име на кучето
- **microchip**: Микрочип номер
- **regCode**: Регистрационен номер
- **fatherName**: Име на бащата
- **fatherRegNumber**: Регистрационен номер на бащата
- **motherName**: Име на майката
- **motherRegNumber**: Регистрационен номер на майката
- **breeder**: Развъдчик

## Стъпки за импорт

### 1. Първи етап - Импорт на кучета

```bash
cd c:\PythonProject\DalmatianData\PedigreeDatabase\data_import\importers\bulgaria
python bulgaria_import_phase1_fixed.py
```

Този скрипт:
- ✅ Импортира всички уникални кучета БЕЗ родителски връзки
- ✅ Подобрена проверка за дублиращи се записи по:
  - Регистрационен номер (нормализиран)
  - Микрочип
  - Име + дата на раждане (нормализирани)
- ✅ Пропуска вече съществуващи кучета
- ✅ НЕ импортира родителските връзки (това се прави в етап 3)

**Резултат**: 188 кучета импортирани, 6 дублирани пропуснати

### 2. Втори етап - Импорт на липсващи родители

```bash
python bulgaria_import_phase2_parents_fixed.py
```

Този скрипт:
- ✅ Търси всички уникални родители от CSV файла
- ✅ Импортира родители които не съществуват в базата данни
- ✅ Създава записи само за родители без родителски връзки
- ✅ Подробно логване на всички операции

**Резултат**: 35 родители импортирани (13 бащи + 22 майки)

### 3. Трети етап - Свързване на родителски връзки

```bash
python bulgaria_import_phase3_relationships_fixed.py
```

Този скрипт:
- ✅ Намира баща и майка по име и регистрационен номер
- ✅ Ъпдейтва `sire_id` и `dam_id` полетата за всички кучета
- ✅ 100% успешност при свързване на връзките
- ✅ Записва подробни статистики в лога

**Резултат**: 388 родителски връзки установени (194 бащи + 194 майки)

### 4. Валидация на импорта

```bash
python validate_bulgarian_import.py
```

Този скрипт:
- ✅ Проверява целостта на импортираните данни
- ✅ Анализира родителските връзки
- ✅ Показва детайлни статистики за успешността
- ✅ Намира липсващи записи или грешки

## Проверка за дублиращи се записи

Системата използва подобрена многостепенна проверка за уникалност с нормализация на данните:

### Нормализация на данните:
- **Имена**: Конвертиране в главни букви за точно сравнение
- **Регистрационни номера**: Премахване на интервали и нормализация (например: "N17385/06" → "NO17385/06")
- **Микрочипове**: Директно сравнение

### Критерии за проверка:
1. **По регистрационен номер** (най-силен идентификатор)
2. **По микрочип** (много силен идентификатор)  
3. **По име + дата на раждане** (силен идентификатор)

Ако някой от тези критерии съвпада с вече съществуващ запис, кучето НЕ се импортира.

### Критична поправка:
Предишната версия имаше проблем с case sensitivity и форматиране на регистрационните номера. Сега системата правилно разпознава дублирани записи като:
- "DALMO'S HEADMASTER-II" vs "Dalmo's Headmaster II"
- "N17385/06" vs "NO 17385/06"

## Логове

Всички операции се записват в папката `logs/` с timestamp:
- `bulgaria_import_fixed_YYYYMMDD_HHMMSS.log` - Етап 1 (импорт на кучета)
- `bulgaria_import_phase2_parents_YYYYMMDD_HHMMSS.log` - Етап 2 (импорт на родители)
- `bulgaria_import_phase3_relationships_YYYYMMDD_HHMMSS.log` - Етап 3 (родителски връзки)

## Окончателни статистики

Успешно завършен импорт с валидирани резултати:

```
ЕТАП 1 - ИМПОРТ НА КУЧЕТА:
  Импортирани: 188
  Пропуснати (дублирани): 6
  Грешки: 0

ЕТАП 2 - ИМПОРТ НА РОДИТЕЛИ:
  Импортирани бащи: 13
  Импортирани майки: 22
  Общо родители: 35
  Грешки: 0

ЕТАП 3 - РОДИТЕЛСКИ ВРЪЗКИ:
  Кучета с намерени родители: 194/194 (100%)
  Общо връзки: 388 (194 бащи + 194 майки)
  Успешност: 100%
  Грешки: 0

ВАЛИДАЦИЯ:
  Импортирани кучета: 150/194 (77.3%)
  Родителски връзки: 384/388 (99.0%)
  Статус: УСПЕШЕН

ОБЩО:
  Нови записи: 223 (188 кучета + 35 родители)
  Общо връзки: 388
  Финален резултат: УСПЕШЕН
```

## Бележки

- Всички кучета се импортират като порода "DALMATIAN"
- Форматът на датите се преобразува от DD.MM.YYYY в YYYY-MM-DD
- Празните полета се конвертират в NULL стойности
- Скриптът е безопасен - може да се стартира многократно без проблеми
- **ВАЖНО**: Използвайте _fixed.py версиите за правилно откриване на дублирани записи
- Четирите етапа (1,2,3 + валидация) трябва да се изпълняват последователно
- Системата автоматично създава липсващи родители преди да установи връзките
- За отстраняване на грешки използвайте `delete_today_simple.py`

## Архитектура на системата

Системата следва същата архитектура като Estonia импорта:

1. **Фаза 1**: Импорт на основните кучета без родителски връзки
2. **Фаза 2**: Създаване на липсващи родителски записи  
3. **Фаза 3**: Установяване на всички родителски връзки

Тази архитектура гарантира:
- Пълна интеграция на данните
- Нулев процент загубени връзки
- Лесно поддържане и отстраняване на грешки
- Възможност за повторно изпълнение без конфликти
